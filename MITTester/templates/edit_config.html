<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - 修改配置</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="shortcut icon" href="/static/img/Mit_favicon.ico">
    <link href="../../static/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../static/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../static/css/animate.css" rel="stylesheet">
    <link href="../../static/css/style.css?v=4.1.0" rel="stylesheet">


</head>

<body class="gray-bg">
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
        <h2>添加配置</h2>
        <ol class="breadcrumb">
            <li>
                <a href="">主页</a>
            </li>
            <li>
                <strong>配置管理</strong>
            </li>
        </ol>
    </div>
    <div class="col-sm-8">
        <div class="title-action">
            <a href="add_case.html" class="btn btn-primary">活动区域</a>
        </div>
    </div>
</div>

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-12">
            <div class="">
                <ul class="nav nav-tabs" id="tab-test">
                    <li><a href="#messages_1">messages</a></li>
                    <li><a href="#variables_1">variables</a></li>
                    <li><a href="#request_1">request</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="messages_1">
                        <div class="am-tab-panel" id="tab1">
                            <form class="form-horizontal" id="form_config">
                                <div class="form-group has-feedback has-info">
                                    <label for="config_name" class="col-md-2 control-label text-info"
                                           style="font-size: 14px;">config_name:</label>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="config_name" placeholder="接口配置名称"
                                               name="config_name" value="{{ info.name }}">
                                        <span class="glyphicon glyphicon-certificate form-control-feedback"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>
                                <div id="element_id">
                                    <div class="form-group has-success">
                                        <label for="project" class="col-md-2 control-label text-info"
                                               style="font-size: 14px;">project:</label>
                                        <div class="col-md-4">
                                            <select class="form-control Site_name" name="project" data-value="{{info.belong_project}}"></select>
                                        </div>
                                    </div>
                                    <div class="form-group has-success">
                                        <label for="config_module" class="col-md-2 control-label text-info"
                                               style="font-size: 14px;">module:</label>
                                        <div class="col-md-4">
                                            <select class="form-control App_name" name="config_module">
                                                <option value="{{ module_name }}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group has-feedback has-info">
                                        <label for="config_author" class="col-md-2 control-label text-info"
                                               style="font-size: 14px;">author:</label>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="dev_name" placeholder="创建者"
                                                   name="config_author"
                                                   value="{{ info.author}}">
                                            <span class="glyphicon glyphicon-user form-control-feedback"
                                                  aria-hidden="true"></span>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane" id="variables_1">
                        <div class="am-tab-panel" id="tab2">
                            <button class="btn btn-info" value="添 加" onclick="addNewRow('variables')">add variables
                            </button>
                            <button class="btn btn-danger" value="删 除" onclick="removeRow('variables')">del variables
                            </button>
                            <form id="config_variables">
                                <table class="table table-hover table-condensed table-bordered table-striped"
                                       id="variables">
                                    <caption>Variables:</caption>
                                    <thead>
                                    <tr class="active text-success">
                                        <th width="5%" align="center">Option</th>
                                        <th width="40%" align="center">Key</th>
                                        <th width="55%" align="center">Value</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        {% for foo in request.variables %}
                                            <tr>
                                                <td><input type="checkbox" name="variables"
                                                           id="chkArr_{{ forloop.counter }}" style="width:55px"></td>
                                                {% for key, value in foo.items %}
                                                    <td><input type="text" name="cell1_keyvariables{{ forloop.parentloop.counter }}"
                                                               id="nodename{{ forloop.parentloop.counter }}"
                                                               value="{{ key }}" style="width:100%; border: none"></td>
                                                    <td><input type="text"
                                                               name="cell2_valuevariables{{ forloop.parentloop.counter }}"
                                                               id="nodename{{ forloop.parentloop.counter }}" value="{{ value }}"
                                                               style="width:100%; border: none"></td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                </table>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane" id="request_1">
                        <div class="am-tab-panel" id="tab3">
                            <div class="form-inline">
                                <div class="form-group has-success">
                                    <label for="config_url" style="font-size: 14px;">Base Url:</label>
                                    <input type="text" class="form-control am-input-sm " placeholder="Base url"
                                           name="url" id="config_url" value="{{ request.request.base_url }}">
                                </div>
                                <div class="form-group has-warning ">
                                    <label for="DataType" style="font-size: 14px;"><code>&nbsp;</code>DataType:</label>
                                    <select class="form-control" name="DataType" id="config_data_type">
                                        <option>data</option>
                                        <option>json</option>
                                        <option>params</option>
                                    </select>
                                </div>
                                <button class="btn btn-info" value="添 加" onclick="addNewRow('data')">add data</button>
                                <button class="btn btn-danger" value="删 除" onclick="removeRow('data')">del data</button>
                                <button class="btn btn-info" value="添 加" onclick="addNewRow('header')">add headers
                                </button>
                                <button class="btn btn-danger" value="删 除" onclick="removeRow('header')">del headers
                                </button>
                                <form id="config_request_data">
                                    <table class="table table-hover table-condensed table-bordered table-striped"
                                           id="data">
                                        <caption>request:</caption>
                                        <thead>
                                        <tr class="active text-success">
                                            <th width="5%" align="center">Option</th>
                                            <th width="40%" align="center">Key</th>
                                            <th width="55%" align="center">Value</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        {% if 'data' in request.request.keys %}
                                                {% for key, value in request.request.data.items %}
                                                    <tr>
                                                        <td><input type="checkbox" name="data" id="chkArr_{{ forloop.counter }}"
                                                                   style="width:55px">
                                                        </td>
                                                        <td><input type="text" name="cell1_keydata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ key }}"
                                                                   style="width:100%; border: none"></td>
                                                        <td><input type="text" name="cell2_valuedata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ value }}"
                                                                   style="width:100%; border: none"></td>
                                                    </tr>
                                                {% endfor %}
                                            {% elif 'params' in request.request.keys %}
                                                {% for key, value in request.request.params.items %}
                                                    <tr>
                                                        <td><input type="checkbox" name="data" id="chkArr_{{ forloop.counter }}"
                                                                   style="width:55px">
                                                        </td>
                                                        <td><input type="text" name="cell1_keydata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ key }}"
                                                                   style="width:100%; border: none"></td>
                                                        <td><input type="text" name="cell2_valuedata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ value }}"
                                                                   style="width:100%; border: none"></td>
                                                    </tr>
                                                {% endfor %}

                                            {% elif 'json' in request.request.keys %}
                                                {% for key, value in request.request.json.items %}
                                                    <tr>
                                                        <td><input type="checkbox" name="data" id="chkArr_{{ forloop.counter }}"
                                                                   style="width:55px">
                                                        </td>
                                                        <td><input type="text" name="cell1_keydata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ key }}"
                                                                   style="width:100%; border: none"></td>
                                                        <td><input type="text" name="cell2_valuedata{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ value }}"
                                                                   style="width:100%; border: none"></td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                    </table>
                                </form>
                                <form id="config_request_headers">
                                    <table class="table table-hover table-condensed table-bordered table-striped"
                                           id="header">
                                        <caption>headers:</caption>
                                        <thead>
                                        <tr class="active text-success">
                                            <th width="5%" align="center">Option</th>
                                            <th width="40%" align="center">Key</th>
                                            <th width="55%" align="center">Value</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% if 'headers' in request.request.keys %}
                                                {% for key, value in request.request.headers.items %}
                                                    <tr>
                                                        <td><input type="checkbox" name="header" id="chkArr_{{ forloop.counter }}"
                                                                   style="width:55px">
                                                        </td>
                                                        <td><input type="text" name="cell1_keyheader{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ key }}"
                                                                   style="width:100%; border: none"></td>
                                                        <td><input type="text" name="cell2_valueheader{{ forloop.counter }}"
                                                                   id="nodename{{ forloop.counter }}" value="{{ value }}"
                                                                   style="width:100%; border: none"></td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="">
    <div class="" style="margin-left: 11%;">
        <button type="button" class="" onclick="config_ajax()">点 击 提 交</button>&nbsp;
        &raquo; &nbsp;
        <a type="submit" href="/api/edit_config/" class="">新 增 配 置</a>

    </div>
</div>
<!-- 全局js -->
<script src="../../static/js/jquery.min.js?v=2.1.4"></script>
<script src="../../static/js/bootstrap.min.js?v=3.3.6"></script>
<script src="../../static/js/jquery.serializejson.min.js"></script>

<!-- 自定义js -->
<script src="../../static/js/content.js?v=1.0.0"></script>
<script>
    index = 1;

    function addNewRow(id) {
        var tabObj = document.getElementById(id);//获取添加数据的表格
        var rowsNum = tabObj.rows.length;  //获取当前行数
        var attribute = id;
        var style = 'width:100%; border: none';
        var cellHtml1 = "<input type='text' name='cell1_key" + id + index + "'  value='' style='" + style + "' />";
        var cellHtml2 = "<input type='text' name='cell2_value" + id + index + "' value='' style='" + style + "' />";
        var cellHtml3 = "<input type='text' name='cell3_value" + id + index + "' value='' style='" + style + "' />";
        var myNewRow = tabObj.insertRow(rowsNum);
        var newTdObj0 = myNewRow.insertCell(0);
        var newTdObj1 = myNewRow.insertCell(1);
        var newTdObj2 = myNewRow.insertCell(2);
        newTdObj0.innerHTML = "<input type='checkbox' name='" + attribute + "' id='chkArr_" + index + "' style='width:55px' />";
        newTdObj1.innerHTML = cellHtml1;
        if (id !== 'validate') {
            newTdObj2.innerHTML = cellHtml2;
        } else {
            newTdObj2.innerHTML = "<select name='cell_2comparator" + id + index + "' class='form-control' style='height: 25px; font-size: 15px; " +
                "padding-top: 0px; padding-left: 0px; border: none'> " +
                "<option>equals</option> <option>contains</option> <option>startswith</option> <option>endswith</option> <option>regex_match</option> <option>type_match</option> <option>contained_by</option> <option>less_than</option> <option>less_than_or_equals</option> <option>greater_than</option> <option>greater_than_or_equals</option> <option>not_equals</option> <option>string_equals</option> <option>length_equals</option> <option>length_greater_than</option> <option>length_greater_than_or_equals</option> <option>length_less_than</option> <option>length_less_than_or_equals</option></select>";
            var newTdObj3 = myNewRow.insertCell(3);
            newTdObj3.innerHTML = cellHtml3;
        }
        index++;

    }

    /*表格删除行*/
    function removeRow(id) {
        var attribute = id;
        var chkObj = document.getElementsByName(attribute);
        var tabObj = document.getElementById(id);
        for (var k = 0; k < chkObj.length; k++) {
            if (chkObj[k].checked) {
                tabObj.deleteRow(k + 1);
                k = -1;
            }
        }
    }

    $(function () {
        $('#tab-test a:last').tab('show');
    })
    $('#tab-test a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    })

</script>
<script>
    function config_ajax() {
        var url = $("#config_url").serializeJSON();
        var dataType = $("#config_data_type").serializeJSON();
        var caseInfo = $("#form_config").serializeJSON();
        var variables = $("#config_variables").serializeJSON();
        var request_data = $("#config_request_data").serializeJSON();
        var headers = $("#config_request_headers").serializeJSON();
        var test_index={{ info.id }};
        var config = {
            "config": {
                "test_index":test_index,
                "name": caseInfo,
                "variables": variables,
                "request": {
                    "base_url": url.url,
                    "headers": headers,
                    "type": dataType.DataType,
                    "request_data": request_data
                }
            }
        };
        $.ajax({
            type: 'post',
            url: '/api/edit_config/',
            data: JSON.stringify(config),
            contentType: "application/json",
            success: function (data) {
                if (data === 'ok') {
                    window.location.reload();
                    //window.location.href = "/api/login";
                } else {
                     alert(data)
                }
            },
            error: function () {
                alert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });
    }
</script>
<script src="../../static/js/jquery.cxselect.js"></script>
<script>
    $('#element_id').cxSelect({
        url: '/version/filter_app/',
        selects: ['Site_name', 'App_name'],
        jsonName: 'name',
        jsonSub: 'value',
        nodata: 'none'
    })
</script>

</body>

</html>
